<?xml version="1.0" encoding="utf-8" ?>
<mdscript name="JumpLIB" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="E:/Mod Stuff/X4 Extracted/2.5beta/libraries/md.xsd">
    <cues>
        <!-- <cue name="JumpInstance" namespace="this" instantiate="true">
            <conditions>
                <event_object_signalled object="player.entity" param2="'move_generic_jump'" />
            </conditions>
            <actions>
                <set_value name="$Destination" exact="event.param.{1}" />
                <do_if value="$Destination.isclass.sector == true or $Destination.isclass.cluster == true">
                    <find_gate name="$Destination" space="$Destination" multiple="false"></find_gate>
                </do_if>
                <do_else>
                    <find_gate name="$Destination" space="$Destination.sector" multiple="false"></find_gate>
                </do_else>

                <debug_text text="'JUMPSHITHERE' + $Destination.knownname" />
                <set_value name="$ShipList" exact="event.param.{2}" />
                <debug_text text="'JUMPSHITHERE' + $ShipList.{1}.knownname" />
            </actions>
            <cues>
                <cue name="">
                    <actions>
                        <signal_cue_instantly cue="" />
                    </actions>
                </cue>
                <cue name="Sub_Loop">
                    <conditions>
                        <event_cue_signalled />
                    </conditions>

                </cue>
                <cue name="Sub_Recurse">
                    <conditions>
                        <event_cue_signalled />
                    </conditions>

                </cue>
            </cues>
        </cue> -->

        <cue name="JumpInstance" namespace="this" instantiate="true">
            <conditions>
                <event_object_signalled object="player.entity" param2="'move_generic_jump'" />
            </conditions>
            <actions>
                <set_value name="$ODestination" exact="event.param.{1}" />
                <debug_text text="'JUMPSHITHERE Original Destination is ' + $ODestination.knownname + ' class: ' + $ODestination.class" />

                <do_if value="$ODestination.isclass.sector == true or $ODestination.isclass.cluster == true">
                    <find_gate name="$Destination" space="$ODestination" multiple="false"></find_gate>
                </do_if>
                <do_else>
                    <find_gate name="$Destination" space="$ODestination.sector" multiple="false"></find_gate>
                </do_else>

                <debug_text text="'JUMPSHITHERE' + $Destination.knownname" />
                <set_value name="$ShipList" exact="event.param.{2}" />
                <do_if value="this.ship.subordinates.count gt 0">
                    <debug_text text="'JUMPSHITHERE We have subordinates! ' + this.ship.subordinates.count" />
                    <set_value name="$SubsList" exact="$ShipList.{1}.subordinates" />
                    <do_all exact="$SubsList.count" counter="$i">
                        <append_to_list name="$ShipList" exact="$SubsList.{$i}" />
                        <debug_text text="'JUMPSHITHERE Subs' + $SubsList.{$i}.knownname" />
                    </do_all>
                </do_if>
                <debug_text text="'JUMPSHITHERE' + $ShipList.{1}.knownname" />
            </actions>
            <cues>
                <cue name="Jump_Sender" ref="md.JumpLIB.JumpLIB">
                    <param name="Destination" value="$Destination" />
                    <param name="ShipList" value="$ShipList" />
                </cue>
            </cues>
        </cue>

        <library name="JumpLIB">
            <params>
                <param name="Destination" default="null" />
                <param name="ShipList" default="null" />
                <param name="Signal" default="null" />
                <param name="Delay" default="150ms" />
            </params>
            <cues>
                <cue name="Init" instantiate="true">
                    <actions>
                        <set_value name="$ShipReturn" exact="$ShipList.clone" />
                    </actions>
                    <cues>
                        <cue name="Jump_Start">
                            <actions>
                                <signal_cue cue="Jump_Effect" />
                            </actions>
                        </cue>
                        <cue name="Jump_Effect" instantiate="true">
                            <conditions>
                                <event_cue_signalled />
                            </conditions>
                            <actions>
                                <do_if value="$ShipList.{1}?">
                                    <debug_to_file text="'Jump_Effect ' + player.age + ' ' + $ShipList.count" name="'shipprofileslib.log'" directory="'ship profiles'" />
                                    <set_value name="$ShipLength" exact="$ShipList.{1}.length" />
                                    <create_position name="$PositionOld" space="$ShipList.{1}.zone" min="1km" max="10km" />
                                    <create_position name="$EffectPosOld" x="$PositionOld.x" y="$PositionOld.y" z="$PositionOld.z + $ShipLength" />
                                    <create_position name="$Position" space="$Destination.zone" min="1km" max="10km" />
                                    <create_position name="$EffectPos" x="$Position.x" y="$Position.y" z="$Position.z + $ShipLength" />
                                    <do_if value="$ShipList.{1}.isclass.ship_s">
                                        <add_effect effect="'tpwar_warp_small'" object="$Destination.zone">
                                            <position value="$EffectPos" />
                                        </add_effect>
                                        <add_effect effect="'tpwar_warp_small'" object="$ShipList.{1}.zone">
                                            <position value="$EffectPosOld" />
                                        </add_effect>
                                    </do_if>
                                    <do_if value="$ShipList.{1}.isclass.ship_m">
                                        <add_effect effect="'tpwar_warp_medium'" object="$Destination.zone">
                                            <position value="$EffectPos" />
                                        </add_effect>
                                        <add_effect effect="'tpwar_warp_medium'" object="$ShipList.{1}.zone">
                                            <position value="$EffectPosOld" />
                                        </add_effect>
                                    </do_if>
                                    <do_if value="$ShipList.{1}.isclass.ship_l">
                                        <add_effect effect="'tpwar_warp_large'" object="$Destination.zone">
                                            <position value="$EffectPos" />
                                        </add_effect>
                                        <add_effect effect="'tpwar_warp_large'" object="$ShipList.{1}.zone">
                                            <position value="$EffectPosOld" />
                                        </add_effect>
                                    </do_if>
                                    <do_if value="$ShipList.{1}.isclass.ship_xl">
                                        <add_effect effect="'tpwar_warp_xl'" object="$Destination.zone">
                                            <position value="$EffectPos" />
                                        </add_effect>
                                        <add_effect effect="'tpwar_warp_xl'" object="$ShipList.{1}.zone">
                                            <position value="$EffectPosOld" />
                                        </add_effect>
                                    </do_if>
                                    <signal_cue_instantly cue="Jump_Warp" param="$Position" />
                                </do_if>
                            </actions>
                        </cue>
                        <cue name="Jump_Warp" instantiate="true">
                            <conditions>
                                <event_cue_signalled />
                            </conditions>
                            <delay exact="$Delay" />
                            <actions>
                                <do_if value="$ShipList.{1}?">
                                    <warp object="$ShipList.{1}" zone="$Destination.zone">
                                        <position x="event.param.x" y="event.param.y" z="event.param.z" />
                                    </warp>
                                    <remove_from_list name="$ShipList" exact="$ShipList.{1}" />
                                </do_if>
                                <signal_cue cue="Jump_Cleanup" />
                            </actions>
                        </cue>
                        <cue name="Jump_Cleanup" instantiate="true">
                            <conditions>
                                <event_cue_signalled />
                            </conditions>
                            <delay exact="$Delay" />
                            <actions>
                                <do_if value="$ShipList.count == 0">
                                    <signal_objects object="player.entity" param="$Signal" param2="$ShipReturn" param3="$Destination" />
                                    <cancel_cue cue="Jump_Effect" />
                                    <cancel_cue cue="Jump_Warp" />
                                    <cancel_cue cue="Jump_Cleanup" />
                                    <cancel_cue cue="Init" />
                                </do_if>
                                <do_else>
                                    <signal_cue cue="Jump_Effect" />
                                </do_else>
                            </actions>
                        </cue>
                    </cues>
                </cue>
            </cues>
        </library>
    </cues>
</mdscript>